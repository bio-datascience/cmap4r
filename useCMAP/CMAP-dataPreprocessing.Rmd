---
title: <center> <h1> Data retrieval </h1> </center>  
# author: Aditya Kumar Mishra
output: html_document
keep_md: true
# output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width=12, fig.height=8,fig.align = "center",
                      out.width = "100%")
rm(list = ls())
# source('~/Dropbox (Simons Foundation)/CMAP/dataAccess/CMAP-Access/cmap4r/R/cmap4r.R')
library(cmap4r)
library(dplyr)
library(DBI)
```


User can process the data, a) by downloading the data as **data frame** to the local computer; or b) using the  functions from the **dbplyr** package which facilitates data preparation (like mutation, aggregation) on the database itself. To ensure optimal usage of the hardware resources, we recommend downloading the data to the local computer and then processing it for further analysis.

To retrieve the data from **CMAP**, a user need to specify following parameters:

+ Table Name (table.name)
+ Variables to be extracted (sel.var)
+ Range variable includes (latitude, longitude, depth, time)

Use **getTableData** function to download the data as data frame. 


```{r message=FALSE, warning=FALSE, echo=TRUE}
con <- dbConnect(odbc::odbc(), DSN="CMAP-MSSQL",UID="ArmLab",PWD="ArmLab2018")

## Input: Table name; variable name, space time range information
table.name = 'tblsst_AVHRR_OI_NRT'      # table name
sel.var = 'sst'                         # choose variable 
range.var <- list()                     # Range variable [lat,lon,time]
range.var$lat <- c(10,70)
range.var$lon <- c(-180,-80)
range.var$time <- c('2016-04-30', '2016-04-30')

## Subset selection:
tbl.subset <- getTableData(con, table.name, sel.var, range.var)
head(tbl.subset)

dbDisconnect(con)
```

#### Ordered data
Arrange data by specifying order variables in the data download function **getTableData**. 

```{r message=FALSE, warning=FALSE, echo=TRUE}
con <- dbConnect(odbc::odbc(), DSN="CMAP-MSSQL",UID="ArmLab",PWD="ArmLab2018")

## Input: Table name; variable name, space time range information
table.name = 'tblsst_AVHRR_OI_NRT'      # table name
sel.var = 'sst'                         # choose variable 
range.var <- list()                     # Range variable [lat,lon,time]
range.var$lat <- c(10,70)
range.var$lon <- c(-180,-80)
range.var$time <- c('2016-04-30', '2016-04-30')


## Ordering of the numeric variable:
orderby <- c('time','lat','lon')        # Specify orderby variable
tbl.subset <- getTableData(con, table.name, sel.var, range.var,orderby)
head(tbl.subset)

dbDisconnect(con)
```

#### Aggregate data
To avoid pulling large dataset from the CMAP server, especially when not required, the user may be interested in pulling aggregated data. In addition to the essential input variables, the user needs to specify the aggregate variable(**agg.var**). 



```{r message=FALSE, warning=FALSE, echo=TRUE}
con <- dbConnect(odbc::odbc(), DSN="CMAP-MSSQL",UID="ArmLab",PWD="ArmLab2018")

## Input: Table name; variable name, space time range information
table.name = 'tblsst_AVHRR_OI_NRT'      # table name
sel.var = 'sst'                         # choose variable 
range.var <- list()                     # Range variable [lat,lon,time]
range.var$lat <- c(25,30)
range.var$lon <- c(-160,-155)
range.var$time <- c('2016-03-29', '2016-05-29')   


## Aggregate
agg.var <- 'time'                       # Specify aggregate variable
tbl.subset <- getAggregatedTableData(con, table.name, sel.var, range.var, agg.var)
head(tbl.subset)

dbDisconnect(con)
```


## Data preprocessing

After getting the data to the local workplace, here we provide some simple examples to process the data like mutation, column summary. Many more such examples will follow. 



```{r  message=FALSE, warning=FALSE, echo=TRUE}
con <- dbConnect(odbc::odbc(), DSN="CMAP-MSSQL",UID="ArmLab",PWD="ArmLab2018")

table.name <- 'tblSST_AVHRR_OI_NRT'
sel.var <- 'sst'                                  
range.var <- list()
range.var$lat <- c(25,30)
range.var$lon <- c(-160,-155)
range.var$time <- c('2016-03-29', '2016-05-29')  





## Part I
## Mutate (locally) a column to define a new column variable:
## The section allows us to perform some basic operations (such as +, *, -, /) 
## on selected colums of the table matrix.
orderby <- c('time') 
tbl.subset <- getTableData(con, table.name, sel.var, range.var,orderby)
tbl.mutate <-  tbl.subset %>% mutate( temVar1 = sst^2,temVar2 = sst/2, 
                                      temVar3 = sst/mean(sst,na.rm = TRUE))
head(tbl.mutate)









## Part II
## Custom - operation on the table selected: for example - min max sd length/count; 
table.name <- 'tblSST_AVHRR_OI_NRT'
sel.var <- 'sst'                                  
range.var <- list()
range.var$lat <- c(25,30)
range.var$lon <- c(-160,-155)
range.var$time <- c('2016-03-29', '2016-05-29')         


## Get aggregated table on the local computer:
agg.var <- 'time' 
tbl.subset <- getAggregatedTableData(con, table.name, sel.var, range.var, agg.var)
tbl.custom <- tbl.subset %>% summarise_at(sel.var,funs(min, length, mean , max)) 
head(tbl.custom)

dbDisconnect(con)
```


