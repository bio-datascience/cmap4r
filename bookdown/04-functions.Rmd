```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=8,fig.align = "center",
                      out.width = "100%")
library(DBI)
library(dplyr)
## library(cmap4r)
```

# Functions in our R package

The full set of functions available are here.

## Download table

The user can process the data, a) by downloading the data as **data frame** to
the local computer; or b) using the functions from the **dbplyr** package which
facilitates data preparation (like mutation, aggregation) on the database
itself. To ensure optimal usage of the hardware resources (Justin's comment:
don't we mean "to minimize communication costs incurred with the server"?), we
recommend downloading the data to the local computer and then processing it for
further analysis.

To retrieve the data from **CMAP**, a user need to specify following parameters:

+ Table Name (table.name)
+ Variables to be extracted (sel.var)
+ Range variable includes (latitude, longitude, depth, time)

Use **getTableData** function to download the data as data frame. 


```{r message=FALSE, warning=FALSE, echo=TRUE, eval=FALSE}
con <- dbConnect(odbc::odbc(), DSN="CMAP-MSSQL",UID="ArmLab",PWD="ArmLab2018")

## Input: Table name; variable name, space time range information
table.name = 'tblsst_AVHRR_OI_NRT'      # table name
sel.var = 'sst'                         # choose variable 
range.var <- list()                     # Range variable [lat,lon,time]
range.var$lat <- c(10,70)
range.var$lon <- c(-180,-80)
range.var$time <- c('2016-04-30', '2016-04-30')

## Subset selection:
tbl.subset <- getTableData(con, table.name, sel.var, range.var)
head(tbl.subset)

dbDisconnect(con)
```


## Summarize table

We explain how to get attributes of a table. A typical table's attributes include:

+ name of variables 
+ type of variables, i.e., quantitative, qualitative, time, 
+ size of the table
+ space-time range information
+ numerical variable range summary


```{r  message=FALSE, warning=FALSE, echo=TRUE, eval=FALSE}
con <- dbConnect(odbc::odbc(), DSN="CMAP-MSSQL",UID="ArmLab",PWD="ArmLab2018")

## Choose table:
table.name <-  "tblsst_AVHRR_OI_NRT"


  
# Variable name in the table
tbl.fields <- dbListFields(con,table.name)
print(tbl.fields)


## collect sample data 
tbl.fields <- getDataSample(con,table.name,n=5)
print(tbl.fields) 


# Class of each column in the table
tbl.colClass <- getColClass(con,table.name)
print(tbl.colClass)


# Number of observations
nObs <- getObservationCount(con,table.name)
nObs


# Space/time information of the table
tbl.spaceTimeInfo <- getSpaceTimeRange(con,table.name)
print(tbl.spaceTimeInfo)



# Numeric variable range:
tbl.rangeNumVar <- getRangeNumVar(con,table.name)
print(tbl.rangeNumVar)
  

dbDisconnect(con)
```


## Visualization

You have two built-in options for making plots -- scatter plots to compare two
variable of interest, or histograms.

### Scatterplots
Specify following parameters to retrieve required data.

+ Table Name (table.name)
+ Variables to be extracted (sel.var)
+ Range variable includes (latitude, longitude, depth, time)


In addition to this, specify “agg.var” parameter to aggregate the variable of interest, and align the data from the two tables. For example, we select agg.var = "time". 

<!-- In addition to this, specify aggregate variable. For example, we select agg.var = "time". We use this variable to allign the data from the two table downloaded from the CMAP.  -->


**plot_xy** function download the data, and output a list which contain a) plot object: **plot_ly/ggplot**; b) corresponding data tables. 




```{r message=FALSE, warning=FALSE, echo=TRUE, eval=FALSE}
con <- dbConnect(odbc::odbc(), DSN="CMAP-MSSQL",UID="ArmLab",PWD="ArmLab2018")
# Inpit variable:
# 
table.list <- c('tblSST_AVHRR_OI_NRT', 'tblAltimetry_REP') 
var.list <-  c('sst', 'sla')  
#
range.var <- list()
range.var$lat <- c(25,30)
range.var$lon <- c(-160, -155)
range.var$time <- c('2016-03-29', '2016-05-29')
#
agg.var <- 'time' 

## -----------------------------------
## Dataset from table II
selIndex <- 1
table.name <- table.list[selIndex]                       # Specify table name I
sel.var <- var.list[selIndex]                            # Variable from table name I  

tbl.subset.x <- getAggregatedTableData(con, table.name, sel.var, range.var, agg.var)
head(tbl.subset.x)


## Dataset from table II
selIndex <- 2
table.name <- table.list[selIndex]                       # Specify table name II
sel.var <- var.list[selIndex]                            # Variable from table name II


tbl.subset.y <- getAggregatedTableData(con, table.name, sel.var, range.var, agg.var)
head(tbl.subset.y)



## Plot - XY
# out <- plot_xy(con, table.list,var.list,range.var,agg.var,type = 'ggplot')
out <- plot_xy(con, table.list,var.list,range.var,agg.var,type = 'plotly')
out$plot
dbDisconnect(con)
```

### Histograms 

To generate a histogram plot of a variable of interest, a user needs to specify the following parameters: 

+ Table Name (table.name)
+ Variables to be extracted (sel.var)
+ Range variable includes (latitude, longitude, depth, time)

to retrieve data from **CMAP**. 

Call **plot_depth** function to obtain **plot_ly/ggplot** object. 

Take the following example

```{r message=FALSE, warning=FALSE, echo=TRUE, eval=FALSE}
con <- dbConnect(odbc::odbc(), DSN="CMAP-MSSQL",UID="ArmLab",PWD="ArmLab2018")

# Inpit variable:
table.list <- c('tblSST_AVHRR_OI_NRT', 'tblArgoMerge_REP', 'tblArgoMerge_REP') 
var.list <-  c('sst', 'argo_merge_temperature_adj', 'argo_merge_salinity_adj')  

# variable "sst" selected from "tblSST_AVHRR_OI_NRT"
selIndex <- 1
table.name <- table.list[selIndex]
sel.var <- var.list[selIndex]   


# Range variable
range.var <- list()
range.var$lat <- c(20, 24)
range.var$lon <- c(-170, 150)
range.var$time <- c('2016-04-30', '2016-04-30')



# Subset selection:
tbl.subset <- getTableData(con, table.name, sel.var, range.var)
head(tbl.subset)


## Plot function available for R User
# p <- plot_hist(tbl.subset,'ggplot',sel.var)
p <- plot_hist(tbl.subset,'plotly',sel.var)
p


dbDisconnect(con)
```












## Colocalize data

First, what does it mean to *colocalize*? Imagine a ship moving along a
trajectory, whose location in space and time is recorded in
latitude/longitude/time. Then, we'd like to get ocean attributes, like sea
surface temperature or salinity, *as if we were recording it along the ship's
trajectory*. Colocalization simply means getting such attributes *manually* from
the database, by obtaining data from the *vicinity* of each lat/lon/time triplet
and summarizing it (e.g. take mean or standard deviation). The vicinity is
define by the user-specified slack in longitude, latitude and time. For
instance, one could define vicinity by asking for 1/4 degrees of slack in
longitude and latitude, and 6 hours of slack in time.

Long story short, the basic idea is: query "rectangle" region's subtable for
every lat/lon/time triplet, for each variable.

The main function to do this is `matchSource_onetable`, which colocalizes data
for one table at a time (the `table.name` variable from the catalog), and one or
more variables in that table (the `sel.var` variable, again from the
catalog). The latitude/longitude/time triplets are to be in a CSV file whose
path you'll supply in the variable `source`. Here is a short example:

```{r, echo=TRUE, eval=FALSE}
## Setup 
con = DBI::dbConnect(odbc::odbc(), DSN="CMAP-MSSQL",UID="ArmLab",PWD="ArmLab2018")
latMargin = 0.3
lonMargin = 0.3
timeMargin = 1
source = '~/Desktop/MGL1704-veryshort.csv'
table.name = "tblSST_AVHRR_OI_NRT"
sel.var = "sst"
res = matchSource_onetable(con, source, table.name, sel.var, latMargin, lonMargin, timeMargin)
print(head(res))
```
